<!DOCTYPE html>
<html>
<head>
    <title>Smart Lock | Dual State 3D</title>
    <script type="module" src="https://unpkg.com/@splinetool/viewer@1.12.60/build/spline-viewer.js"></script>
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.9.3/dist/dotlottie-wc.js" type="module"></script>
    
    <style>
        body, html {
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            font-family: 'Segoe UI', sans-serif; color: white;
            overflow: hidden; background: #000;
        }

        /* 3D Background Layer */
        .bg-3d {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
        }

        .ui-container {
            position: relative; z-index: 2; height: 100vh;
            display: flex; align-items: center; justify-content: center;
        }

        .glass-card {
            background: rgba(10, 10, 20, 0.4);
            backdrop-filter: blur(30px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px; padding: 40px; text-align: center;
            width: 380px; box-shadow: 0 40px 100px rgba(0,0,0,0.7);
        }

        .lottie-container {
            width: 100%; height: 300px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            margin: 10px 0; transition: transform 0.2s ease;
        }

        .lottie-container:active { transform: scale(0.95); }

        .btn-connect {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            border: none; padding: 14px 40px; border-radius: 50px;
            color: white; font-weight: 700; cursor: pointer;
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
            margin-bottom: 10px;
        }

        .status-tag {
            font-size: 10px; letter-spacing: 3px;
            color: rgba(255,255,255,0.4); text-transform: uppercase;
            margin-bottom: 20px;
        }

        #instruction { transition: color 0.3s ease; }
    </style>
</head>
<body>

    <spline-viewer class="bg-3d" url="https://prod.spline.design/0r7Umfe4ZeMa08ZL/scene.splinecode"></spline-viewer>

    <div class="ui-container">
        <div class="glass-card">
            <button class="btn-connect" id="connectBtn" onclick="connectBLE()">SECURE CONNECT</button>
            <div class="status-tag" id="status">Hardware Offline</div>

            <div class="lottie-container" onclick="toggleLock()">
                <dotlottie-wc
                    id="lockLottie"
                    src="https://lottie.host/58253552-c4cf-4471-a877-dd4f1b8d7f38/hVAgYqaSeh.lottie" 
                    autoplay
                    loop>
                </dotlottie-wc>
            </div>

            <h2 id="instruction" style="color: #4facfe;">LOCKED</h2>
            <p style="font-size: 11px; opacity: 0.5;">Tap animation to toggle hardware</p>
        </div>
    </div>

    <script>
        let lockCharacteristic;
        let isLocked = true;

        // Your two specific Lottie URLs
        const URL_LOCKED_ANIM = "https://lottie.host/58253552-c4cf-4471-a877-dd4f1b8d7f38/hVAgYqaSeh.lottie";
        const URL_UNLOCKED_ANIM = "https://lottie.host/edf966d0-960c-4191-8afd-1177d04017bb/fbgQuuIaXt.lottie";

        async function connectBLE() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Lock' }],
                    optionalServices: ['12345678-1234-5678-1234-56789abcdef0']
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('12345678-1234-5678-1234-56789abcdef0');
                lockCharacteristic = await service.getCharacteristic('12345678-1234-5678-1234-56789abcdef2');
                
                document.getElementById('status').innerText = "Encrypted Link Active";
                document.getElementById('status').style.color = "#00f2fe";
                document.getElementById('connectBtn').style.display = "none";
            } catch (error) {
                document.getElementById('status').innerText = "Connection Failed";
            }
        }

        async function toggleLock() {
            if (!lockCharacteristic) {
                alert("Please initialize secure link first!");
                return;
            }

            const lottie = document.getElementById('lockLottie');
            const label = document.getElementById('instruction');
            
            // Determine command based on current state
            const command = isLocked ? "OPEN" : "CLOSE";

            try {
                // 1. Send command to ESP32
                await lockCharacteristic.writeValueWithResponse(new TextEncoder().encode(command));
                
                // 2. Success! Now flip state and update UI
                isLocked = !isLocked;
                
                if (isLocked) {
                    // Switch to "Locked" Animation
                    lottie.setAttribute('src', URL_LOCKED_ANIM);
                    label.innerText = "LOCKED";
                    label.style.color = "#4facfe";
                } else {
                    // Switch to "Unlocked" Animation
                    lottie.setAttribute('src', URL_UNLOCKED_ANIM);
                    label.innerText = "UNLOCKED";
                    label.style.color = "#00ff88";
                }

                console.log("Hardware acknowledged: " + command);
            } catch (error) {
                console.error("BLE Error:", error);
                document.getElementById('status').innerText = "Link Interrupted";
            }
        }
    </script>
</body>
</html>